<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
<!--If the customer has no VAT, we must show 'Consumidor final'-->
    <template id="l10n_pt_partner_vat">
        <t t-if="o.company_id.account_fiscal_country_id.code">
            NIF:
            <t t-if="o.partner_id.vat">
                <t t-esc="o.partner_id.vat"/>
            </t>
            <t t-else="">
                <t t-esc="'Consumidor final'"/>
            </t>
        </t>
    </template>
    <template id="l10n_pt_report_invoice_document_inherit" inherit_id="account.report_invoice_document">
<!--    Add tax exemption reason-->
        <xpath expr="//p[@name='payment_communication']" position="before">
            <t t-set="tax_exemption_reasons" t-value="o._l10n_pt_get_vat_exemptions_reasons()"/>
            <t t-if="tax_exemption_reasons">
                <div><strong>Motivos de isenção de IVA:</strong></div>
                <t t-foreach="tax_exemption_reasons" t-as="reason">
                    <div><t t-esc="reason"/></div>
                </t>
                <br/>
            </t>
        </xpath>

<!--    Add accumulated amount column-->
        <xpath expr="//th[@name='th_total']" position="after">
            <t t-if="report_type == 'pdf' and len(o.invoice_line_ids) > 5">  <!-- TODO: change ? -->
                <th class="text-end">Acc. amount</th>
            </t>
        </xpath>
        <xpath expr="//td[@name='td_total']" position="after">
            <t t-if="report_type == 'pdf' and len(o.invoice_line_ids) > 5">  <!-- TODO: change ? -->
                <td class="text-end o_price_total">
                    <t t-out="current_subtotal" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                </td>
            </t>
        </xpath>
<!--    Disable the accumulated amount resetting happening after a line section-->
        <xpath expr="//tr[hasclass('is-subtotal')]" position="replace"/>
        <xpath expr="//t[@name='line_section_reset_current_subtotal']" position="replace"/>

<!--    If the customer has no VAT, we must show 'Consumidor final'-->
        <xpath expr="//div[@name='address_not_same_as_shipping']//div[@id='partner_vat_address_not_same_as_shipping']" position="replace">
            <t t-call="l10n_pt.l10n_pt_partner_vat"/>
        </xpath>
        <xpath expr="//div[@name='address_same_as_shipping']//div[@id='partner_vat_address_same_as_shipping']" position="replace">
            <t t-call="l10n_pt.l10n_pt_partner_vat"/>
        </xpath>
        <xpath expr="//div[@name='no_shipping']//div[@id='partner_vat_no_shipping']" position="replace">
            <t t-call="l10n_pt.l10n_pt_partner_vat"/>
        </xpath>

<!--    QR Code-->
        <xpath expr="//div[@id='qrcode']" position="replace">
            <t t-if="o.company_id.account_fiscal_country_id.code == 'PT' and o.l10n_pt_qr_code_str">
                <img t-if="o.l10n_pt_qr_code_str"
                     style="margin: 0.25cm;"
                     t-att-src="'/report/barcode/?barcode_type=%s&amp;value=%s&amp;width=%s&amp;height=%s'%('QR', o.l10n_pt_qr_code_str, 150, 150)"/>
            </t>
        </xpath>
    </template>
</odoo>
