<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

<!-- Specific Forum Layout -->
<template id="forum_index" name="Forum">
    <t t-call="website_forum.header">
        <t t-set="no_filters" t-value="not filters in ('solved', 'unsolved', 'unanswered')"/>

        <!-- Filter post by type -->
        <nav class="o_wforum_nav navbar justify-content-between px-0 mt-3">
            <div class="d-flex align-items-baseline">
                <button class="navbar-toggler d-lg-none ps-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#user_sidebar"><i class="oi oi-panel-right"></i></button>
                <ol class="breadcrumb px-0 mb-0">
                    <li class="o_wforum_forum_name_breadcrumb breadcrumb-item">
                        <t t-if="my">
                            <a class="fs-5" t-attf-href="/forum/#{ slug(forum) }" t-esc="forum.name"/>
                        </t>
                        <t t-else="">
                            <span class="fs-5 fw-bold" t-esc="forum.name"/>
                        </t>
                    </li>
                    <li t-if="my" t-attf-class="breadcrumb-item">
                        <span t-if="my == 'favourites'" class="fs-5 fw-bold"> My Favourites</span>
                        <span t-elif="my == 'followed'" class="fs-5 fw-bold">Posts I'm Following</span>
                        <span t-elif="my == 'mine'" class="fs-5 fw-bold"> My Posts</span>
                        <span t-elif="my == 'tagged'" class="fs-5 fw-bold"> Tags I'm Following</span>
                    </li>
                </ol>
            </div>
            <div class="d-flex">
                <t t-if="not no_filters or (no_filters and question_count)">
                    <div class="dropdown me-2">
                        <a href="#" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <t t-if="no_filters"> All</t>
                            <t t-elif="filters == 'solved'"> Solved</t>
                            <t t-elif="filters == 'unsolved'"> Unsolved</t>
                            <t t-elif="filters == 'unanswered'"> Unanswered</t>
                        </a>
                        <div class="dropdown-menu" role="menu">
                            <a t-att-href="url_for('') + '?' + keep_query( 'search', 'sorting', filters='all')"
                                class="dropdown-item">
                                All
                            </a>
                            <div class="dropdown-divider"/>
                            <t t-if="forum.mode == 'questions'">
                                <a t-att-href="url_for('') + '?' + keep_query( 'search', 'sorting', filters='solved')"
                                    class="dropdown-item">Solved
                                </a>
                                <a t-att-href="url_for('') + '?' + keep_query( 'search', 'sorting', filters='unsolved')"
                                    class="dropdown-item">Unsolved
                                </a>
                            </t>
                            <a t-att-href="url_for('') + '?' + keep_query( 'search', 'sorting', filters='unanswered')"
                                class="dropdown-item">Unanswered
                            </a>
                        </div>
                    </div>
                </t>
                <!-- 'Search Box' -->
                <t t-call="website.website_search_box_input">
                    <t t-set="search_type" t-valuef="forums"/>
                    <t t-set="action" t-value="'/forum/%s%s' % (slug(forum), tag and ('/tag/%s/questions' % slug(tag)) or '')"/>
                    <t t-set="display_description" t-valuef="true"/>
                    <t t-set="display_detail" t-valuef="true"/>
                    <input t-if="filters" type="hidden" name="filters" t-att-value="filters"/>
                    <input t-if="my" type="hidden" name="my" t-att-value="my"/>
                    <input t-if="sorting" type="hidden" name="sorting" t-att-value="sorting"/>
                </t>
                <t>
                    <div t-if="uid and request.env.user.forum_waiting_posts_count"
                         data-bs-title="You already have a pending post"
                         data-bs-toggle="popover"
                         data-bs-trigger="hover"
                         data-bs-content="Please wait for a moderator to validate your previous post before continuing.">
                        <a class="disabled btn btn-primary ms-2 mb-3 mb-md-0" t-attf-href="/forum/#{slug(forum)}/ask">New Post</a>
                    </div>
                    <a t-elif="uid" role="button" type="button" class="btn btn-primary o_forum_ask_btn ms-2" t-att-href="'/forum/' + slug(forum) + '/ask'">New Post</a>
                </t>
            </div>
        </nav>
        <div t-if="search or tag" t-attf-class="d-flex justify-content-end flex-md-grow-1 #{(search) and 'col-12 flex-column-reverse flex-md-row mb-3' or 'col-md-auto order-md-3'}">
            <div class="d-flex flex-wrap align-items-center flex-grow-1">
                <span t-if="search" class="mb-2 mb-md-0 me-1 border rounded ps-2 d-inline-flex align-items-center justify-content-between">
                    <em class="">"<t t-esc="search"/>"</em>
                    <a t-att-href="url_for('') + '?' + keep_query( 'filters', 'sorting', 'my')" class="btn py-1">&#215;</a>
                </span>
                <span t-if="tag" t-attf-class="mb-2 mb-md-0 border rounded ps-2 d-inline-flex align-items-center justify-content-between #{(search) and 'ms-md-2'}">
                    <div>
                        <span class="fa fa-tag text-muted me-1"/>
                        <span t-esc="tag.name"/>
                    </div>
                    <a t-att-href="url_for('/forum/') + slug(forum) + '?' + keep_query( 'search', 'sorting', 'filters', 'my')" class="btn py-1">&#215;</a>
                </span>
            </div>
        </div>

        <!-- List questions or search/filters result -->
        <table t-if="question_count != 0" class="o_wforum_table table mb-5" height="1">
            <thead>
                <tr class="d-none d-lg-table-row">
                    <th class="o_wforum_table_title"></th>
                    <th class="o_wforum_table_posters"></th>
                    <th class="o_wforum_table_replies small fw-normal text-center">
                        <a t-att-href="sorting=='child_count desc' and url_for('') + '?' + keep_query( 'search', 'filters', sorting='child_count asc') or url_for('') + '?' + keep_query( 'search', 'filters', sorting='child_count desc')">
                            Replies <i t-attf-class="fa fa-caret-#{sorting=='child_count desc' and 'down' or 'up'}  #{sorting == 'child_count desc' or sorting == 'child_count asc' and ' ' or 'd-none'}"></i>
                        </a>
                    </th>
                    <th class="o_wforum_table_views small fw-normal text-center">
                        <a t-att-href="sorting=='views desc' and url_for('') + '?' + keep_query( 'search', 'filters', sorting='views asc') or url_for('') + '?' + keep_query( 'search', 'filters', sorting='views desc')">
                            Views <i t-attf-class="fa fa-caret-#{sorting=='views desc' and 'down' or 'up'}  #{sorting == 'views desc' or sorting == 'views asc' and ' ' or 'd-none'}"></i>
                        </a>
                    </th>
                    <th class="o_wforum_table_activity small fw-normal text-center">
                        <a t-att-href="sorting=='write_date desc' and url_for('') + '?' + keep_query( 'search', 'filters', sorting='write_date asc') or url_for('') + '?' + keep_query( 'search', 'filters', sorting='write_date desc')">
                            Activity <i t-attf-class="fa fa-caret-#{sorting=='write_date desc' and 'down' or 'up'}  #{sorting == 'write_date desc' or sorting == 'write_date asc' and ' ' or 'd-none'}"></i>
                        </a>
                    </th>
                </tr>
            </thead>
            <!-- <t t-if="my == 'tagged'" t-foreach="tags" t-as='tag'> -->
                <t t-out="tag_ids"></t>
            <!-- </t> -->
            <t t-foreach="question_ids" t-as="question">
                <t t-call="website_forum.display_post">
                    <t t-set="show_author_avatar" t-value="true"/>
                </t>
            </t>
        </table>

        <!-- No posts or search/filters result -->
        <div t-if="question_count == 0 or original_search" class="col">
            <div t-if="search or tag or (not no_filters)" class="alert alert-info mt-3">
                <t t-set="_filters_str">
                    <t t-if="filters == 'unanswered'">&amp;nbsp;unanswered</t>
                    <t t-elif="filters == 'solved'">&amp;nbsp;solved</t>
                    <t t-elif="filters == 'unsolved'">&amp;nbsp;unsolved</t>
                </t>
                <t t-set="_my_str">
                    <t t-if="my == 'favourites'">&amp;nbsp;in your favourites</t>
                    <t t-if="my == 'followed'">&amp;nbsp;in your followed list</t>
                    <t t-if="my == 'mine'">&amp;nbsp;in your posts</t>
                </t>
                <t t-set="_search_str">&amp;nbsp;<t t-if="search">matching "<em class="fw-bold" t-esc="original_search or search"/>"</t></t>
                <t t-set="_search_and_tag_str"><t t-if="search and tag">&amp;nbsp;and&amp;nbsp;</t></t>
                <t t-set="_tag_str"><t t-if="tag">using the <span class="badge text-bg-light" t-esc="tag.name"/> tag</t></t>
                <t t-set="result_msg">
                    Sorry, we could not find any<b>%s</b> results<b>%s</b>%s%s%s.
                </t>
                <span t-out="result_msg % (_filters_str.strip(), _my_str.strip(), _search_str.strip(), _search_and_tag_str.strip(), _tag_str.strip())"/>
                <span t-if="original_search">Showing results for <em class="fw-bold" t-esc="search"/> instead.</span>
            </div>

            <t t-elif="not tag and not search and no_filters">
                <div t-if="my == 'followed'" class="alert alert-info text-center">
                    You are not following any topic in this forum (yet).<br/>
                    <a t-attf-href="/forum/#{slug(forum)}/" class="btn btn-info mt-2">Browse All</a>
                </div>
                <div t-elif="my == 'favourites'" class="alert alert-info text-center">
                    No favourite questions in this forum (yet).<br/>
                    <a t-attf-href="/forum/#{slug(forum)}/" class="btn btn-info mt-2">Browse All</a>
                </div>
                <div t-elif="my == 'mine'" class="alert alert-info text-center">You have no posts in this forum (yet).</div>
                <div t-elif="my == 'tagged'" class="alert alert-info text-center">
                    <t t-if="forum.post_ids.tag_ids">You are not following any tags (yet).
                        <br/>
                        <a t-attf-href="/forum/#{slug(forum)}/tag" class="btn btn-info mt-2">Browse All</a>
                    </t>
                    <t t-else="">There are no tags to follow.</t>

                </div>
            </t>

            <div t-elif="filters == 'unanswered'" class="alert alert-info">Amazing! There are no unanswered questions left!</div>
            <div t-elif="no_filters and not search and not tag and not my" class="alert alert-info">
                <b>This forum is empty.</b><br/>
                Be the first to ask a question.
            </div>

            <t t-if="search and question_count == 0">
                <h4>Search Tips</h4>
                <ul>
                    <li>Check your spelling and try again.</li>
                    <li>Try searching for one or two words.</li>
                    <li>Be less specific in your wording for a wider search result.</li>
                </ul>
            </t>
        </div>

        <t t-call="website.pager"/>
    </t>
</template>

<!-- Edition: ask your question -->
<template id="new_question" name="New Post">
    <t t-call="website_forum.header">
        <div t-if="request.env.user.forum_waiting_posts_count" class="alert border" role="alert">
            <b>You already have a pending post.</b><br/>
            <p>Please wait for a moderator to validate your previous post before continuing.</p>
            <a t-attf-href="/forum/#{ slug(forum) }" title="All Topics"><i class="fa fa-chevron-left me-2"/>Back to All Topics</a>
        </div>

        <form t-else="" t-attf-action="/forum/#{slug(forum)}/new" method="post" role="form" class="tag_text js_website_submit_form js_wforum_submit_form o_wforum_readable mt-3">
            <div class="row mb-3">
                <label class="col-2 form-label small" for="content">Title</label>
                <div class="col">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <input type="text" name="post_name" required="required" pattern=".*\S.*" t-attf-value="#{post_name}"
                        class="form-control" placeholder="Write a clear, explicit and concise title" title="Title must not be empty"/>
                    <input type="hidden" name="karma" t-attf-value="#{user.karma}" id="karma"/>
                    <div class="form-text small text-muted">
                        <a data-bs-toggle="collapse" href="#newQuestionExample" role="button" aria-expanded="false" aria-controls="newQuestionExample">
                            Example
                            <i class="fa fa-question-circle"/>
                        </a>
                        <div class="collapse" id="newQuestionExample">
                            <div class="text-success mt-2">
                                <i class="fa fa-check"/> How to configure TPS and TVQ's canadian taxes?
                            </div>
                            <div class="text-danger">
                                <i class="fa fa-times"/> Good morning to all! Please, can someone help solve my tax computation problem in Canada? Thanks!
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <label class="col-2 form-label small" for="content">Description</label>
                <div class="col">
                    <textarea name="content" required="required" id="content" class="form-control o_wysiwyg_loader" t-att-data-karma="forum.karma_editor">
                        <t t-esc="question_content"/>
                    </textarea>
                    <span class="small form-text text-muted d-inline"><i class="fa fa-lightbulb-o"></i> Tip: consider adding an example. </span>
                </div>
            </div>
            <div class="row mb-3">
                <label class="col-2 form-label small" for="post_tags">Tags</label>
                <div class="col">
                    <input type="hidden" name="karma_tag_create" t-attf-value="#{forum.karma_tag_create}" id="karma_tag_create"/>
                    <input type="hidden" name="karma_edit_retag" t-attf-value="#{forum.karma_edit_retag}" id="karma_edit_retag"/>
                    <input type="hidden" name="post_tags" placeholder="Tags" class="form-control js_select2"/>
                </div>
            </div>
            <div class="row mb-5">
                <div class="col offset-2">
                    <button type="submit" t-attf-class="btn btn-primary o_wforum_submit_post #{forum.allow_share and 'oe_social_share_call'} #{(user.karma &lt; forum.karma_ask) and 'karma_required'}"
                    t-att-data-karma="forum.karma_ask"
                    data-hashtags="#question" data-social-target-type="question">Post Your Question</button>
                    <a class="btn btn-secondary" title="Back to Question" t-attf-href="/forum/#{ slug(forum) }"> Discard</a>
                </div>
            </div>
        </form>
    </t>
</template>

<!-- Edition: edit a post -->
<template id="edit_post" name="Edit Post">
    <t t-call="website_forum.header">
        <div t-if="is_answer" class="fw-bold mb-1">Question by <t t-esc="post.parent_id.create_uid.sudo().name"/></div>
        <article t-if="is_answer" class="alert border pb-0 o_wforum_readable">
            <h5 class="mb-1 text-muted" t-esc="post.parent_id.name"/>
            <div t-field="post.parent_id.content" class="o_wforum_post_content text-muted oe_no_empty"/>
        </article>
        <form t-attf-action="/forum/#{slug(forum)}/post/#{slug(post)}/save" method="post" role="form" class="tag_text js_website_submit_form js_wforum_submit_form o_wforum_readable">
            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
            <div t-if="not is_answer" class="mb-3">
                <label class="form-label" for="post_name">Title</label>
                <input type="text" name="post_name" required="required" pattern=".*\S.*" t-attf-value="#{post.name}"
                    class="form-control form-control-lg" placeholder="Edit your Post" title="Title must not be empty"/>
                <span class="small my-2 text-muted"><i class="fa fa-lightbulb-o"></i> Tip: Use a clear, explicit and concise title <a data-bs-toggle="collapse" href="#newQuestionExample" role="button" aria-expanded="false" aria-controls="newQuestionExample">
                    (ex:
                    <i class="fa fa-question-circle"/>)
                </a></span>
                <div class="collapse small text-muted" id="newQuestionExample">
                    <div class="">
                        <i class="fa fa-check text-success"/> How to configure TPS and TVQ's canadian taxes?
                    </div>
                    <div class="">
                        <i class="fa fa-times text-danger"/> Good morning to all! Please, can someone help solve my tax computation problem in Canada? Thanks!
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label t-if="not is_answer" class="form-label" for="content">Description</label>
                <label t-else="" class="form-label">Your Answer</label>
                <textarea name="content" id="content" required="required" class="form-control o_wysiwyg_loader" t-att-data-karma="forum.karma_editor">
                    <t t-esc="post.content"/>
                </textarea>
                <span t-if="not is_answer" class="small form-text text-muted mt-n2"><i class="fa fa-lightbulb-o"></i> Tip: consider adding an example. </span>
            </div>
                <input type="hidden" name="karma" t-attf-value="#{user.karma}" id="karma"/>
            <div t-if="not is_answer" class="mb-3">
                <label class="form-label" for="post_tags">Tags</label>
                <input type="hidden" name="karma_tag_create" t-attf-value="#{forum.karma_tag_create}" id="karma_tag_create"/>
                <input type="hidden" name="karma_edit_retag" t-attf-value="#{forum.karma_edit_retag}" id="karma_edit_retag"/>
                <t t-set="edit_tags_karma_fail" t-value="user.karma &lt; forum.karma_edit_retag"/>
                <t t-set="edit_tags_karma_error_message">You need to have sufficient karma to edit tags</t>
                <input type="text" name="post_tags" class="form-control js_select2" placeholder="Tags" t-attf-data-init-value="#{tags}" value="Tags"
                       t-att-readonly="edit_tags_karma_fail and 'readonly'"
                       t-att-title="edit_tags_karma_fail and edit_tags_karma_error_message"/>
            </div>
            <div class="mb-4">
                <button type="submit" class="btn btn-primary o_wforum_submit_post">Save Changes</button>
                <a class="btn btn-secondary" title="Back to Question" t-attf-href="/forum/#{ slug(forum) }/#{ slug(post)}">
                    Discard
                </a>
            </div>
        </form>
    </t>
</template>

<template id="tag" name="Forum Tags">
    <t t-call="website_forum.header">
        <t t-if="pager_tag_chars">
            <t t-if="len(pager_tag_chars) &lt; 11">
                <ul class="pagination border-transparent mt0 mb0">
                    <t t-foreach="pager_tag_chars" t-as="tuple_char">
                        <t t-if="tuple_char_index &lt; 11">
                            <li t-attf-class="page-item #{active_char_tag == tuple_char[1] and 'active'}"><a t-attf-href="/forum/#{slug(forum)}/tag/#{quote_plus(tuple_char[1])}" class="page-link"><t t-esc="tuple_char[0]"/></a></li>
                        </t>
                    </t>
                </ul>
            </t>
            <div t-else="" class="d-flex align-items-center" role="toolbar" aria-label="Toolbar with button groups">
                <label for="filter" class="me-2">Show Tags Starting with</label>
                <select name="filter" class="form-select w-auto" onchange="location = this.value;">
                    <t t-foreach="pager_tag_chars" t-as="tuple_char">
                        <option t-if="active_char_tag == tuple_char[1]" selected="selected" value="" t-esc="tuple_char[0]"/>
                        <option t-else="" t-attf-value="/forum/#{slug(forum)}/tag/#{quote_plus(tuple_char[1])}" t-esc="tuple_char[0]"/>
                    </t>
                </select>
            </div>
        </t>

        <div class="row mt-3 mb-5" t-if="tags">
            <t t-foreach="tags" t-as="tag">
                <div t-if="len(tag.post_ids) > 0" class="col-md-3 o_js_forum_tag_follow">
                    <div class="d-flex">
                        <a t-attf-class="btn btn-link px-0 #{tag.message_is_follower and 'text-900 fw-bold' or 'text-600'}"
                           t-attf-href="/forum/#{ slug(forum) }/tag/#{ slug(tag) }/questions?{{ keep_query( filters='tag') }}">
                            <t t-esc="tag.name"/>
                            <!-- [TODO] Note: tag.posts_count didn't work properly, setting 1 to a tag with 0 posts -->
                            <span class="small">(<t t-out="len(tag.post_ids)"/>)</span>
                        </a>
                        <t t-call="website_mail.follow">
                            <t t-set="email" t-value="user_id.email"/>
                            <t t-set="object" t-value="tag"/>
                            <t t-set="icons_design" t-value="True"/>
                        </t>
                    </div>
                </div>
            </t>
        </div>
        <div t-else="" class="alert alert-info text-center">
            There are no tags being used in this forum.
        </div>
    </t>
</template>

    </data>
</odoo>
