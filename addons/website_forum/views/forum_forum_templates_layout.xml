<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

<!-- GLOBAL LAYOUT -->
<!-- ============================================================ -->

<!-- website_forum.layout removes the access right check for wysiwyg bundle -->
<template id="layout" inherit_id="website.layout" name="Forum Layout" primary="True">
    <xpath expr="//div[@id='wrapwrap']" position="before">
        <t t-set="pageName" t-value="'website_forum'"/>
    </xpath>
    <xpath expr="//div[@id='wrapwrap']" position="attributes">
        <attribute name="t-att-data-forum_id">forum and forum.id</attribute>
    </xpath>
    <xpath expr="//div[@id='wrapwrap']//main" position="attributes">
        <attribute name="class">d-flex flex-column</attribute>
    </xpath>
</template>

<!-- PAGE INDEX -->
<!-- ============================================================ -->

<!-- Page Index -->
<template id="header" name="Forum Index">
    <t t-if="forum.active" t-call="website_forum.layout">
        <div class="oe_structure" id="oe_structure_website_forum_header_1"/>
        <div id="wrap" t-attf-class="o_wforum_main_wrapper d-grid h-100 #{website_forum_action}">

            <div class="o_wforum_sidebar d-grid bg-100">
                <t t-call="website_forum.user_sidebar"/>
            </div>

            <div class="o_wforum_main_content">
                <div class="o_wprofile_email_validation_container mb16">
                    <t t-call="website_profile.email_validation_banner">
                        <t t-set="redirect_url" t-value="'/forum/%s' % forum.id"/>
                        <t t-set="additional_validation_email_message"> and join this Forum</t>
                        <t t-set="additional_validated_email_message"> You may now participate in our forums.</t>
                    </t>
                    <nav t-if="header.get('is_guidelines') or queue_type or new_question or is_edit or tags or reasons" class="o_wforum_nav d-flex align-items-baseline px-0 mt-3" aria-label="breadcrumb">
                        <button class="navbar-toggler d-lg-none ps-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#user_sidebar"><i class="oi oi-panel-right"></i></button>
                        <ol class="breadcrumb px-0 mb-0">
                            <li class="o_wforum_forum_name_breadcrumb breadcrumb-item">
                                <a class="fs-5" t-attf-href="/forum/#{ slug(forum) }" t-esc="forum.name"/>
                            </li>
                            <t t-if="header.get('is_guidelines')">
                                <li class="breadcrumb-item">
                                    <a t-if="header.get('is_karma')" t-attf-href="/forum/#{ slug(forum) }/faq" class="fs-5">Guidelines</a>
                                    <t t-else="">
                                        <span class="fs-5 fw-bold">Guidelines</span>
                                    </t>
                                </li>
                                <li t-if="header.get('is_karma')" class="breadcrumb-item"><span class="fs-5 fw-bold">Karma</span></li>
                            </t>
                            <li t-if="queue_type" class="breadcrumb-item"><span class="fs-5">Moderation</span></li>
                            <li t-if="queue_type == 'validation'" class="breadcrumb-item"><span class="fs-5 fw-bold">To Validate</span></li>
                            <li t-if="queue_type == 'flagged'" class="breadcrumb-item"><span class="fs-5 fw-bold">Flagged</span></li>
                            <li t-if="queue_type == 'offensive'" class="breadcrumb-item"><span class="fs-5 fw-bold">Offensive</span></li>
                            <li t-if="reasons and offensive" class="breadcrumb-item"><span class="fs-5 fw-bold">Offensive Post</span></li>
                            <li t-if="reasons and not offensive" class="breadcrumb-item"><span class="fs-5 fw-bold">Close Post</span></li>
                            <li t-if="new_question" class="breadcrumb-item"><span class="fs-5 fw-bold">New Post</span></li>
                            <t t-if="is_edit">
                                <t t-set="target" t-value="post.parent_id if is_answer else post"/>
                                <li class="breadcrumb-item text-truncate" style="max-width:150px">
                                    <a t-attf-href="/forum/#{ slug(forum) }/#{ slug(target)}" title="Back to Question" class="fs-5">
                                        <t t-esc="target.name"/>
                                    </a>
                                </li>
                                <li t-if="not is_answer" class="breadcrumb-item"><span class="fs-5 fw-bold">Edit Question</span></li>
                                <li t-if="is_answer" class="breadcrumb-item"><span class="fs-5 fw-bold">Edit Answer</span></li>
                            </t>
                            <li t-elif="tags" class="breadcrumb-item"><span class="fs-5 fw-bold">Tags</span></li>
                        </ol>
                    </nav>
                    <t t-out="0"/>
                </div>
            </div>
        </div>
    </t>
    <t t-else="" t-call="website_forum.layout">
        <t t-set="head">
            <meta name="robots" content="noindex, nofollow" />
        </t>
        <div class="text-center text-muted">
            <p class="css_editable_hidden"><h2>This forum has been archived.</h2></p>
        </div>
    </t>
</template>

<template id="forum_nav_header">
    <div class="navbar navbar-expand-sm navbar-light">
        <div class="container flex-wrap flex-md-nowrap">
            <a t-if="has_back_button_url" class="btn btn-light border me-2 o_back_button" title="Back">
                <i class="fa fa-chevron-left me-1"/>Back
            </a>
            <!-- Desktop -->
            <ul class="navbar-nav me-auto d-none d-lg-flex">
                <li class="nav-item">
                    <a t-if="request.website.forum_count > 1" class="nav-link" href="/forum/" title="All forums">
                        All Forums
                    </a>
                </li>
                <li class="nav-item">
                    <a t-attf-href="/forum/#{ slug(forum) }" t-attf-class="nav-link #{question_count and 'active'}">Topics</a>
                </li>
                <li class="nav-item">
                    <a t-attf-href="/profile/users?forum_origin=#{request.httprequest.path}"
                        t-attf-class="nav-link #{searches.get('users') and 'active'}">People</a>
                </li>
                <li class="nav-item">
                    <a t-attf-href="/forum/#{ slug(forum) }/tag" t-attf-class="nav-link #{searches.get('tags') and 'active'}">Tags</a>
                </li>
                <li class="nav-item">
                    <a t-attf-href="/profile/ranks_badges?badge_category=forum&amp;url_origin=#{request.httprequest.path}&amp;name_origin=#{forum.name}"
                    t-attf-class="nav-link #{searches.get('badges') and 'active'}">Badges</a>
                </li>
                <li class="nav-item">
                    <a t-attf-href="/forum/#{ slug(forum) }/faq" t-attf-class="nav-link #{header.get('is_guidelines') and 'active'}">About</a>
                </li>
            </ul>

            <!-- Mobile -->
            <ul class="navbar-nav d-lg-none flex-row flex-grow-1 justify-content-between">
                <span class="navbar-text me-1">Go to:</span>
                <li class="nav-item dropdown me-auto">
                    <a class="nav-link active dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <t t-if="searches.get('users')">People</t>
                        <t t-elif="searches.get('tags')">Tags</t>
                        <t t-elif="searches.get('badges')">Badges</t>
                        <t t-elif="header.get('is_guidelines')">About</t>
                        <t t-elif="uid and my == 'favourites'">Favourites</t>
                        <t t-elif="uid and my == 'mine'">My Posts</t>
                        <t t-elif="uid and my == 'followed'">Following</t>
                        <t t-elif="question">Question</t>
                        <t t-else="">All Topics</t>
                    </a>
                    <div class="dropdown-menu position-absolute">
                        <a t-if="searches or my or question" t-attf-href="/forum/#{ slug(forum) }" class="dropdown-item">All Topics</a>
                        <a t-if="not searches.get('users')" t-attf-href="/profile/users?forum_origin=#{request.httprequest.path}" class="dropdown-item">People</a>
                        <a t-if="not searches.get('tags')" t-attf-href="/forum/#{slug(forum)}/tag" class="dropdown-item">Tags</a>
                        <a t-if="not searches.get('badges')" t-attf-href="/profile/ranks_badges?badge_category=forum&amp;url_origin=#{request.httprequest.path}&amp;name_origin=#{forum.name}" class="dropdown-item">Badges</a>
                        <a t-if="not header.get('is_guidelines')" t-attf-href="/forum/#{ slug(forum) }/faq" class="dropdown-item">About</a>
                        <t t-if="uid">
                            <div class="dropdown-divider"/>
                            <a t-att-href="'/forum/%s/user/%s?forum_origin=%s' % (slug(forum), uid, request.httprequest.path)"
                                class="dropdown-item">My profile</a>
                            <a t-if="my != 'mine'" t-att-href="url_for('') + '?' + keep_query( 'search', 'sorting', 'filters', my='mine')" class="dropdown-item">My Posts</a>
                            <a t-if="my != 'favourites'" t-att-href="url_for('') + '?' + keep_query( 'search', 'sorting', 'filters', my='favourites')" class="dropdown-item">My Favourites</a>
                            <a t-if="my != 'followed'" t-att-href="url_for('') + '?' + keep_query( 'search', 'sorting', 'filters', my='followed')" class="dropdown-item">I'm Following</a>
                            <a t-if="my != 'tagged'" t-att-href="url_for('') + '?' + keep_query( 'search', 'sorting', 'filters', my='tagged')" class="dropdown-item">Tags I Follow</a>
                        </t>
                        <div groups="base.group_erp_manager" class="dropdown-divider"/>
                        <a groups="base.group_erp_manager" t-attf-href="/web#id=#{forum.id}&amp;view_type=form&amp;model=forum.forum" class="dropdown-item">Edit Forum in Backend</a>
                    </div>
                </li>
                <t t-if="user.karma>=forum.karma_moderate">
                    <li t-if="forum.count_posts_waiting_validation" class="nav-item">
                        <a class="nav-link" t-attf-href="/forum/#{slug(forum)}/validation_queue">
                            <i class="fa fa-check-square-o fa-fw text-warning"/>
                            <b t-esc="forum.count_posts_waiting_validation" class="text-800"/>
                        </a>
                    </li>
                    <li t-if="forum.count_flagged_posts" class="nav-item ms-2">
                        <a class="nav-link" t-attf-href="/forum/#{slug(forum)}/flagged_queue">
                            <i class="fa fa-flag fa-fw text-danger"/>
                            <b t-esc="forum.count_flagged_posts" class="text-800"/>
                        </a>
                    </li>
                </t>
                <!-- Mobile 'Search Box' toggler-->
                <li class="nav-item ms-4">
                    <a data-bs-toggle="collapse" href="#o_wforum_search" class="nav-link"><i class="fa fa-search"/></a>
                </li>
            </ul>

            <!-- 'Search Box' -->
            <t t-call="website.website_search_box_input">
                <t t-set="_classes" t-valuef="w-100 w-md-auto pt-2 pt-md-0 d-md-flex"/>
                <t t-set="search_type" t-valuef="forums"/>
                <t t-set="action" t-value="'/forum/%s%s' % (slug(forum), tag and ('/tag/%s/questions' % slug(tag)) or '')"/>
                <t t-set="display_description" t-valuef="true"/>
                <t t-set="display_detail" t-valuef="true"/>
                <input t-if="filters" type="hidden" name="filters" t-att-value="filters"/>
                <input t-if="my" type="hidden" name="my" t-att-value="my"/>
                <input t-if="sorting" type="hidden" name="sorting" t-att-value="sorting"/>
            </t>
        </div>
    </div>
</template>

<template id="website_forum.user_sidebar">
    <div>
        <div t-if="not uid" class="o_wforum_sidebar_section text-center px-3 pt-3">
            <div class="alert alert-info mb-0"><p>You need to sign in to interact with the community.</p>
                <a t-if="is_public_user and forum_welcome_message" href="/web/login" class="btn btn-primary btn-block">Sign in</a>
            </div>

        </div>
        <div t-if="uid" class="o_wforum_sidebar_section pt-3">
            <a t-attf-href="/forum/#{slug(forum)}/user/#{uid}?forum_origin=#{request.httprequest.path}"
                class="nav-link d-flex align-items-center text-reset mb-2"
                data-bs-toggle="tooltip"
                data-trigger="hover"
                title="My profile">
                <img class="o_forum_avatar rounded-3 me-2" t-att-src="website.image_url(user, 'avatar_128', '60x60')" alt="Avatar"/>
                <div>
                    <h6 class="mb-1" t-esc="user_id.name"/>
                    <small class="text-muted"><t t-esc="user_id.karma"/> XP</small>
                </div>
            </a>
        </div>
        <div t-if="uid" class="o_wforum_sidebar_section pt-3">
            <t t-set="location" t-value="url_for('/forum/') + slug(forum) + ( ('/tag/' + slug(tag) + '/questions?') if tag else '?' )"/>

            <!-- My Posts -->
            <a t-attf-class="nav-link #{my == 'mine' and 'text-primary fw-bold disabled' or 'text-reset'}" t-att-href="location + keep_query('search', 'filters', 'sorting', my='mine')">
                <i class="fa fa-user-circle fa-fw opacity-50"/> My Posts
            </a>

            <!-- My Favourites -->
            <a t-attf-class="nav-link #{my == 'favourites' and 'text-primary fw-bold disabled' or 'text-reset'}" t-att-href="location + keep_query( 'search', 'filters', 'sorting', my='favourites')">
                <i class="fa fa-bookmark fa-fw opacity-50"/> Favourites
            </a>

            <!-- My Followed posts -->
            <a t-attf-class="nav-link #{my == 'followed' and 'text-primary fw-bold disabled' or 'text-reset'}" t-att-href="location + keep_query( 'search', 'filters', 'sorting', my='followed')">
                <i class="fa fa-bell fa-fw opacity-50"/> Followed Posts
            </a>

            <!-- My Followed tags -->
            <a t-attf-class="nav-link #{my == 'tagged' and 'text-primary fw-bold disabled' or 'text-reset'}" t-att-href="location + keep_query( 'search', 'filters', 'sorting', my='tagged')">
                <i class="fa fa-tags fa-fw opacity-50"/> Followed Tags
            </a>
        </div>
        <div t-if="user.karma>=forum.karma_moderate or queue_type" class="o_wforum_sidebar_section pt-3">
            <!-- Moderation Tools -->
            <div class="pb-1 fw-bold px-3">Moderation tools</div>
            <a t-attf-class="nav-link #{queue_type == 'validation' and 'text-primary fw-bold disabled' or 'text-reset'}" t-attf-href="/forum/#{slug(forum)}/validation_queue">
                <i class="fa fa-check-square-o fa-fw opacity-50"/> To Validate
                <span t-if="forum.count_posts_waiting_validation > 0" t-attf-class="badge #{forum.count_posts_waiting_validation > 0 and 'text-bg-warning' or 'text-reset'}" t-esc="forum.count_posts_waiting_validation"/>
            </a>
            <a t-attf-class="nav-link #{queue_type == 'offensive' or queue_type == 'flagged' and 'text-primary fw-bold disabled' or 'text-reset'}" t-attf-href="/forum/#{slug(forum)}/flagged_queue">
                <i class="fa fa-flag fa-fw opacity-50"/> Flagged
                <span t-if="forum.count_flagged_posts > 0" id="count_flagged_posts" t-attf-class="badge #{forum.count_flagged_posts > 0 and 'text-bg-danger' or 'text-reset'}" t-esc="forum.count_flagged_posts"/>
            </a>
        </div>
        <div t-if="forum.post_ids.tag_ids" class="o_wforum_sidebar_section pt-3">
            <!-- [TODO] Limit to 5 most used tags -->
            <div class="d-flex pb-1 fw-bold px-3">Tags
                <a class="btn btn-link btn-sm ms-auto" t-attf-href="/forum/#{slug(forum)}/tag">
                    View all
                </a>
            </div>
            <t t-foreach="forum.post_ids.tag_ids" t-as="tag">
                <a t-att-href="'/forum/' + slug(tag.forum_id) + '/tag/' + slug(tag) + '/questions?' + keep_query( 'search', 'sorting', 'my', filters='tag')"
                    t-attf-class="nav-link text-reset">
                    <i class="fa fa-tag fa-fw small opacity-50"/>
                    <t t-esc="tag.name"/>
                </a>
            </t>
        </div>
    </div>
    <div class="o_wforum_sidebar_footer mt-5 p-3 text-center">
        <a class="nav-link small" t-attf-href="/forum/#{slug(forum)}/faq">
            <i class="fa fa-info-circle fa-fw"/> About this forum
        </a>
    </div>
</template>

<template id="forum_oe_structure_top" inherit_id="website_forum.header" name="Forum Welcome Message (oe_structure_forum_top)">
    <xpath expr="//*[hasclass('oe_structure')][@id='oe_structure_website_forum_header_1']" position="replace">
        <div class="oe_structure oe_empty" id="oe_structure_website_forum_header_1">
            <section t-if="editable or (is_public_user and not forum_welcome_message)" t-attf-class="s_cover parallax s_parallax_is_fixed py-3 pt96 pb96 bg-black-50 #{'css_non_editable_mode_hidden' if editable else 'forum_intro'}" data-scroll-background-ratio="1" data-snippet="s_cover">
                <span t-if="forum.image_1920" class="s_parallax_bg oe_img_bg" t-attf-style="background-image: url('#{website.image_url(forum, 'image_1920')}'); background-position: center;"/>
                <div t-if="forum.image_1920" class="o_we_bg_filter bg-black-50"/>
                <div t-field="forum.welcome_message" class="container s_allow_columns"/>
            </section>
        </div>
    </xpath>
</template>

<!-- ERROR MANAGEMENT -->
<!-- ============================================================ -->

<template id="404">
    <t t-call="website_forum.header">
        <div class="oe_structure oe_empty"/>
        <h1 class="mt-4">Question not found!</h1>
        <p>Sorry, this question is not available anymore.</p>
        <p>
            <a t-attf-href="/forum">Return to the question list.</a>
        </p>
    </t>
</template>

    </data>
</odoo>
