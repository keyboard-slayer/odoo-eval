<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <data>
        <template id="template_invoice_main_post">
            <T:TicketBai xmlns:T="urn:ticketbai:emision">
                <t t-call="l10n_es_edi_tbai.template_invoice_bundle"/>
            </T:TicketBai>
        </template>

        <template id="template_invoice_main_cancel">
            <T:AnulaTicketBai xmlns:T="urn:ticketbai:anulacion">
                <t t-call="l10n_es_edi_tbai.template_invoice_bundle"/>
            </T:AnulaTicketBai>
        </template>

        <template id="template_invoice_bundle">
            <Cabecera>
                <IDVersionTBAI t-out="tbai_version"/>
            </Cabecera>
            <Sujetos t-if="is_emission">
                <t t-call="l10n_es_edi_tbai.template_invoice_sujetos"/>
            </Sujetos>
            <Factura t-if="is_emission">
                <t t-call="l10n_es_edi_tbai.template_invoice_factura"/>
            </Factura>
            <IDFactura t-if="not is_emission">
                <t t-call="l10n_es_edi_tbai.template_invoice_sujetos"/>
                <t t-call="l10n_es_edi_tbai.template_invoice_factura"/>
            </IDFactura>
            <HuellaTBAI>
                <EncadenamientoFacturaAnterior t-if="chain_prev_invoice">
                    <SerieFacturaAnterior t-out="chain_prev_invoice.l10n_es_tbai_sequence"/>
                    <NumFacturaAnterior t-out="chain_prev_invoice.l10n_es_tbai_number"/>
                    <FechaExpedicionFacturaAnterior t-out="datetime_strftime(chain_prev_invoice.l10n_es_tbai_registration_date, '%d-%m-%Y')"/>
                    <SignatureValueFirmaFacturaAnterior t-out="chain_prev_invoice.l10n_es_tbai_signature[:100]"/>
                </EncadenamientoFacturaAnterior>
                <Software>
                    <LicenciaTBAI>TBAIGI5A266A7CCDE1EC</LicenciaTBAI>
                    <EntidadDesarrolladora>
                        <NIF>Y9877593G</NIF>
                    </EntidadDesarrolladora>
                    <Nombre>Odoo SA</Nombre>
                    <Version t-out="odoo_version"/>
                </Software>
                <NumSerieDispositivo>TEST-DEVICE-001</NumSerieDispositivo>
            </HuellaTBAI>
        </template>

        <template id="template_invoice_sujetos">
            <Emisor>
                <NIF t-out="sender_vat"/>
                <ApellidosNombreRazonSocial t-out="sender.name"/>
            </Emisor>
            <Destinatarios t-if="is_emission and recipient">
                <IDDestinatario>
                    <NIF t-if="recipient.get('nif')" t-out="recipient['nif']"/>
                    <IDOtro t-else="">
                        <CodigoPais t-if="recipient.get('alt_id_country')" t-out="recipient['alt_id_country']"/>
                        <IDType t-out="recipient['alt_id_type']"/>
                        <ID t-out="recipient['alt_id_number']"/>
                    </IDOtro>
                    <t t-set="partner" t-value="recipient['partner']"/>
                    <ApellidosNombreRazonSocial t-out="partner.name"/>
                    <CodigoPostal t-out="partner.zip"/>
                    <Direccion t-out="recipient['partner_address']"/>
                </IDDestinatario>
            </Destinatarios>
            <VariosDestinatarios t-if="is_emission">N</VariosDestinatarios>
            <!-- Odoo does not support multi-recipient invoices (TBAI does)-->
            <EmitidaPorTercerosODestinatario t-if="is_emission" t-out="thirdparty_or_recipient"/>
        </template>

        <template id="template_invoice_factura">
            <t t-set="is_simplified" t-value="invoice._is_l10n_es_tbai_simplified()"/>
            <CabeceraFactura>
                <SerieFactura t-out="invoice.l10n_es_tbai_sequence"/>
                <NumFactura t-out="invoice.l10n_es_tbai_number"/>
                <t t-if="is_emission">
                    <FechaExpedicionFactura t-out="datetime_strftime(datetime_now, '%d-%m-%Y')"/>
                    <HoraExpedicionFactura t-out="datetime_strftime(datetime_now, '%H:%M:%S')"/>
                    <FacturaSimplificada t-out="'S' if is_simplified else 'N'"/>
                </t>
                <FechaExpedicionFactura t-else="" t-out="datetime_strftime(invoice.l10n_es_tbai_registration_date, '%d-%m-%Y')"/>
                <t t-if="is_refund">
                    <FacturaEmitidaSustitucionSimplificada t-out="'S' if (is_simplified and recipient) else 'N'"/>
                    <FacturaRectificativa>
                        <Codigo t-out="credit_note_code"/>
                        <Tipo>I</Tipo>
                        <!-- TODO also allow credit note Tipo 'S' (optional)
                        <ImporteRectificacionSustitutiva>
                            <BaseRectificada>180.00</BaseRectificada>
                            <CuotaRectificada>20.21</CuotaRectificada>
                        </ImporteRectificacionSustitutiva> -->
                    </FacturaRectificativa>
                    <FacturasRectificadasSustituidas>
                        <IDFacturaRectificadaSustituida>
                            <!-- TODO: support issuing a single credit note for multiple invoices (optional) -->
                            <SerieFactura t-out="credit_note_invoice.l10n_es_tbai_sequence"/>
                            <NumFactura t-out="credit_note_invoice.l10n_es_tbai_number"/>
                            <FechaExpedicionFactura t-out="datetime_strftime(credit_note_invoice.l10n_es_tbai_registration_date, '%d-%m-%Y')"/>
                        </IDFacturaRectificadaSustituida>
                    </FacturasRectificadasSustituidas>
                </t>
            </CabeceraFactura>
            <DatosFactura t-if="is_emission">
                <DescripcionFactura t-out="invoice.invoice_origin or 'manual'"/>
                <DetallesFactura>
                    <IDDetalleFactura t-foreach="invoice_lines" t-as="line_value">
                        <t t-set="line" t-value="line_value['line']"/>
                        <t t-set="discount" t-value="line.price_subtotal / (1 - line.discount / 100) * line.discount / 100"/>
                        <DescripcionDetalle t-esc="line_value['description']"/>
                        <Cantidad t-out="float_repr(line.quantity)"/>
                        <ImporteUnitario t-out="float_repr((line.price_subtotal + discount) / line.quantity * (-1 if is_refund else 1))"/>
                        <Descuento t-out="float_repr(discount)"/>
                        <ImporteTotal t-out="float_repr(line.price_total * (-1 if is_refund else 1))"/>
                    </IDDetalleFactura>
                </DetallesFactura>
                <ImporteTotalFactura t-out="float_repr(amount_total)"/>
                <!-- <RetencionSoportada/> TODO (potentially has to be computed/decided manually) -->
                <!-- <BaseImponibleACoste/> TODO (only applicable with ClaveRegimenIvaOpTrascendencia 06) -->
                <Claves>
                    <IDClave t-foreach="regime_key" t-as="key">
                        <ClaveRegimenIvaOpTrascendencia t-out="key"/>
                    </IDClave>
                </Claves>
            </DatosFactura>
            <TipoDesglose t-if="is_emission">
                <DesgloseFactura t-if="invoice_info.get('DesgloseFactura')">
                    <t t-call="l10n_es_edi_tbai.template_invoice_desglose">
                        <t t-set="desglose" t-value="invoice_info['DesgloseFactura']"/>
                    </t>
                </DesgloseFactura>
                <DesgloseTipoOperacion t-else="">
                    <t t-set="invoice_info" t-value="invoice_info['DesgloseTipoOperacion']"/>
                    <PrestacionServicios t-if="invoice_info.get('PrestacionServicios')">
                        <t t-call="l10n_es_edi_tbai.template_invoice_desglose">
                            <t t-set="desglose" t-value="invoice_info['PrestacionServicios']"/>
                        </t>
                    </PrestacionServicios>
                    <Entrega t-if="invoice_info.get('Entrega')">
                        <t t-call="l10n_es_edi_tbai.template_invoice_desglose">
                            <t t-set="desglose" t-value="invoice_info['Entrega']"/>
                        </t>
                    </Entrega>
                </DesgloseTipoOperacion>
            </TipoDesglose>
        </template>

        <template id="template_invoice_desglose">
            <Sujeta t-if="desglose.get('Sujeta')">
                <t t-set="sujeta" t-value="desglose['Sujeta']"/>
                <Exenta t-if="sujeta.get('Exenta')">
                    <DetalleExenta t-foreach="sujeta['Exenta']['DetalleExenta']" t-as="exenta">
                        <CausaExencion t-out="exenta['CausaExencion']"/>
                        <BaseImponible t-out="float_repr(exenta['BaseImponible'])"/>
                    </DetalleExenta>
                </Exenta>
                <NoExenta t-if="sujeta.get('NoExenta')">
                    <t t-set="no_exenta" t-value="sujeta['NoExenta']"/>
                    <DetalleNoExenta>
                        <!-- TODO DetalleNoExenta: Up to 2, grouped by TipoNoExenta (S1/S2)
                        Tax info imported from SII which only supports one TipoNoExenta at a time. -->
                        <TipoNoExenta t-out="no_exenta['TipoNoExenta']"/>
                        <DesgloseIVA>
                            <DetalleIVA t-foreach="no_exenta['DesgloseIVA']['DetalleIVA']" t-as="detalle">
                                <BaseImponible t-out="float_repr(detalle['BaseImponible'])"/>
                                <TipoImpositivo t-out="float_repr(detalle['TipoImpositivo'])"/>
                                <CuotaImpuesto t-out="float_repr(detalle['CuotaRepercutida'])"/>
                                <TipoRecargoEquivalencia t-if="detalle.get('TipoRecargoEquivalencia')" t-out="float_repr(detalle['TipoRecargoEquivalencia'])"/>
                                <CuotaRecargoEquivalencia t-if="detalle.get('CuotaRecargoEquivalencia')" t-out="float_repr(detalle['CuotaRecargoEquivalencia'])"/>
                                <OperacionEnRecargoDeEquivalenciaORegimenSimplificado t-out="'S' if (is_simplified or detalle.get('TipoRecargoEquivalencia')) else 'N'"/>
                            </DetalleIVA>
                        </DesgloseIVA>
                    </DetalleNoExenta>
                </NoExenta>
            </Sujeta>
            <NoSujeta t-if="desglose.get('NoSujeta')">
                <t t-set="no_sujeta" t-value="desglose['NoSujeta']"/>
                <DetalleNoSujeta>
                    <Causa>RL</Causa>
                    <!-- TODO should be 'OT' if 'the' ClaveRegimen == 10, should be 'RL' if 'some' ClaveRegimen == 08-->
                    <Importe t-out="no_sujeta.get('ImportePorArticulos7_14_Otros')"/>
                    <Importe t-out="no_sujeta.get('ImporteTAIReglasLocalizacion')"/>
                </DetalleNoSujeta>
            </NoSujeta>
        </template>

        <template id="template_digital_signature">
            <ds:Signature t-att-Id="dsig['signature_id']" xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
                <ds:SignedInfo>
                    <ds:CanonicalizationMethod Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
                    <ds:SignatureMethod Algorithm="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"/>
                    <ds:Reference t-att-Id="dsig['reference_uri']" Type="http://www.w3.org/2000/09/xmldsig#Object" URI="">
                        <ds:Transforms>
                            <ds:Transform Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
                            <ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
                            <ds:Transform Algorithm="http://www.w3.org/TR/1999/REC-xpath-19991116">
                                <ds:XPath>not(ancestor-or-self::ds:Signature)</ds:XPath>
                            </ds:Transform>
                        </ds:Transforms>
                        <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>
                        <ds:DigestValue></ds:DigestValue>
                    </ds:Reference>
                    <ds:Reference Type="http://uri.etsi.org/01903#SignedProperties" t-attf-URI="##{dsig['sigproperties_id']}">
                        <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>
                        <ds:DigestValue></ds:DigestValue>
                    </ds:Reference>
                    <ds:Reference t-attf-URI="##{dsig['keyinfo_id']}">
                        <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>
                        <ds:DigestValue></ds:DigestValue>
                    </ds:Reference>
                </ds:SignedInfo>
                <ds:SignatureValue></ds:SignatureValue>
                <ds:KeyInfo t-att-Id="dsig['keyinfo_id']">
                    <ds:X509Data>
                        <ds:X509Certificate t-out="dsig['x509_certificate']"/>
                    </ds:X509Data>
                    <ds:KeyValue>
                        <ds:RSAKeyValue>
                            <ds:Modulus t-out="dsig['public_modulus']"/>
                            <ds:Exponent t-out="dsig['public_exponent']"/>
                        </ds:RSAKeyValue>
                    </ds:KeyValue>
                </ds:KeyInfo>
                <ds:Object>
                    <xades:QualifyingProperties xmlns:xades="http://uri.etsi.org/01903/v1.3.2#" t-attf-Target="##{dsig['signature_id']}">
                        <xades:SignedProperties t-att-Id="dsig['sigproperties_id']">
                            <xades:SignedSignatureProperties>
                                <xades:SigningTime t-out="dsig['iso_now']"/>
                                <xades:SigningCertificateV2>
                                    <xades:Cert>
                                        <xades:CertDigest>
                                            <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>
                                            <ds:DigestValue t-out="dsig['sigcertif_digest']"/>
                                        </xades:CertDigest>
                                        <xades:IssuerSerial>
                                            <ds:X509IssuerName t-out="dsig['x509_issuer_description']"/>
                                            <ds:X509SerialNumber t-out="dsig['x509_serial_number']"/>
                                        </xades:IssuerSerial>
                                    </xades:Cert>
                                </xades:SigningCertificateV2>
                                <xades:SignaturePolicyIdentifier>
                                    <xades:SignaturePolicyId>
                                        <xades:SigPolicyId>
                                            <xades:Identifier t-out="dsig['sigpolicy_url']"/>
                                            <xades:Description t-out="dsig['sigpolicy_description']"/>
                                        </xades:SigPolicyId>
                                        <xades:SigPolicyHash>
                                            <ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>
                                            <ds:DigestValue t-out="dsig['sigpolicy_digest']"/>
                                        </xades:SigPolicyHash>
                                        <xades:SigPolicyQualifiers>
                                            <xades:SigPolicyQualifier>
                                                <xades:SPURI t-out="dsig['sigpolicy_url']"/>
                                            </xades:SigPolicyQualifier>
                                        </xades:SigPolicyQualifiers>
                                    </xades:SignaturePolicyId>
                                </xades:SignaturePolicyIdentifier>
                            </xades:SignedSignatureProperties>
                            <xades:SignedDataObjectProperties>
                                <xades:DataObjectFormat t-attf-ObjectReference="##{dsig['reference_uri']}">
                                    <xades:Description/>
                                    <xades:ObjectIdentifier>
                                        <!-- Identifier below is Uniform Resource Number for MimeType "text/xml" (no specific version) -->
                                        <!-- 1.2.840.10003.5: see http://www.oid-info.com/cgi-bin/display?oid=1.2.840.10003.5&a=display -->
                                        <!-- 109.10: see https://www.loc.gov/z3950/agency/defns/oids.html#5 -->
                                        <xades:Identifier Qualifier="OIDAsURN">urn:oid:1.2.840.10003.5.109.10</xades:Identifier>
                                        <xades:Description/>
                                    </xades:ObjectIdentifier>
                                    <xades:MimeType>text/xml</xades:MimeType>
                                    <xades:Encoding/>
                                </xades:DataObjectFormat>
                            </xades:SignedDataObjectProperties>
                        </xades:SignedProperties>
                    </xades:QualifyingProperties>
                </ds:Object>
            </ds:Signature>
        </template>
    </data>
</odoo>
