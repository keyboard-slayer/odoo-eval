<odoo>
    <template id="portal_my_home_overdue_invoice" name="Portal layout: overdue invoices" inherit_id="portal.portal_breadcrumbs" priority="30">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'overdue_invoices'" t-attf-class="breadcrumb-item active">
                <a t-attf-href="/my/invoices?{{ keep_query() }}">Invoices &amp; Bills</a>
            </li>
            <li t-if="payment" class="breadcrumb-item active">
                <t t-out="payment['reference']"/>
            </li>
            <li t-elif="page_name == 'overdue_invoices'" class="breadcrumb-item active">
                overdue invoices
            </li>
        </xpath>

        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="after">
            <a t-if="page_name == 'invoice' and not invoice and filterby != 'bills' and overdue_invoice_count > 0"
                class='btn btn-primary'
                href='/my/invoices/overdue'>
                Pay overdue
            </a>
        </xpath>
    </template>

    <template id="account_payment.portal_docs_entry" inherit_id="portal.portal_docs_entry">
        <xpath expr="//a" position="inside">
            <t t-out="html_children"/>
        </xpath>
    </template>

    <template id="portal_my_home_account_payment" name="Overdue invoices" customize_show="True" inherit_id="portal.portal_my_home" priority="20">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <t t-set="portal_client_category_enable" t-value="True"/>
            <t t-set="portal_alert_category_enable" t-value="True"/>
        </xpath>
        <div id="portal_alert_category" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="bg_color" t-value="'alert alert-primary align-items-center'"/>
                <t t-set="placeholder_count" t-value="'overdue_invoice_count'"/>
                <t t-set="title">Invoices to pay</t>
                <t t-set="url" t-value="'/my/invoices?filterby=overdue_invoices'"/>
                <t t-set="show_count" t-value="True"/>
                <t t-set="html_children">
                    <button onclick="event.preventDefault(); window.location.href='/my/invoices/overdue'" class="btn btn-secondary ms-auto">
                        Pay Now
                    </button>
                </t>
            </t>
        </div>
    </template> 

    <template id="payment_summary_form" name="Payment Summary">
        <div class="text-bg-light row mx-0 rounded">
            <t t-call="payment.summary_item">
                <t t-set="name" t-value="'amount'"/>
                <t t-set="label">Amount</t>
                <t t-set="value" t-value="abs(amount)"/>
                <t t-set="options"
                    t-value="{'widget': 'monetary', 'display_currency': currency}"/>
            </t>
            <t t-call="payment.summary_item">
                <t t-set="name" t-value="'reference'"/>
                <t t-set="label">Reference</t>
                <t t-set="value" t-value="reference"/>
                <t t-set="include_separator" t-value="True"/>
            </t>
        </div>
    </template>

    <template id="portal_overdue_invoices_page" name="Overdue payments">
        <t t-call="portal.portal_layout">
            <div class="row justify-content-center my-3">
                <div class="col-lg-7">
                    <t t-call="account_payment.payment_summary_form">
                        <t t-set="amount" t-value="payment['amount']"/>
                        <t t-set="reference" t-value="payment['reference']"/>
                    </t>
                    <div class="mt-4">
                        <t t-call="payment.form"/>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="portal_my_invoices_payment" name="Payment on My Invoices" inherit_id="account.portal_my_invoices">
        <xpath expr="//t[@t-call='portal.portal_table']/thead/tr/th[last()]" position="before">
            <th></th>
        </xpath>
        <xpath expr="//t[@t-foreach='invoices']/tr/td[last()]" position="before">
            <td class="text-center">
                <a t-if="invoice._has_to_be_paid()"
                    t-att-href="invoice.get_portal_url(anchor='portal_pay', query_string='&amp;showPaymentModal=true')"
                    title="Pay Now"
                    aria-label="Pay Now"
                    class="btn btn-sm btn-primary"
                    role="button">
                    <i class="fa fa-arrow-circle-right"/><span class='d-none d-md-inline'> Pay Now</span>
                </a>
            </td>
        </xpath>
        <xpath expr="//t[@name='invoice_status_posted']/span[1]" position="before">
            <t t-set="tx_sudo" t-value="invoice.get_portal_last_transaction()"/>
        </xpath>
        <xpath expr="//span[@name='invoice_status_waiting_for_payment']" position="before">
            <span t-elif="invoice.payment_state in ('not_paid', 'partial') and tx_sudo.state == 'authorized'"
                    class="badge rounded-pill text-bg-primary">
                <i class="fa fa-fw fa-check"/>
                <span class="d-none d-md-inline"> Authorized</span>
            </span>
            <span t-elif="invoice.payment_state in ('not_paid', 'partial') and tx_sudo.state == 'pending' and tx_sudo.provider_code not in ('none', 'custom')"
                    class="badge rounded-pill text-bg-warning">
                <span class="d-none d-md-inline"> Pending</span>
            </span>
            <span t-elif="invoice.payment_state in ('paid', 'in_payment') and tx_sudo.state == 'done'" class="badge rounded-pill text-bg-success">
                <i class="fa fa-fw fa-check"></i>
                <span class="d-none d-md-inline"> Paid</span>
            </span>
        </xpath>
    </template>

    <template id="portal_invoice_payment" name="Invoice Payment">
        <div id="portal_invoice_payment" class="row">
            <div class="modal fade" id="pay_with" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header pb-0">
                            <h3 class="modal-title">Pay</h3>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-4">
                                <t t-call="account_payment.payment_summary_form">
                                    <t t-set="amount" t-value="invoice.amount_total_signed"/>
                                    <t t-set="reference" t-value="invoice.payment_reference"/>
                                </t>
                            </div>
                            <div t-if="company_mismatch">
                                <t t-call="payment.company_mismatch_warning"/>
                            </div>
                            <t t-else="" t-call="payment.form"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="portal_invoice_page_inherit_payment" name="Payment on My Invoices" inherit_id="account.portal_invoice_page">
        <xpath expr="//t[@t-call='portal.portal_record_sidebar']//h2[1]" position="after">
            <t t-set="pending_txs" t-value="invoice.transaction_ids.filtered(lambda tx: tx.state in ('pending', 'authorized') and tx.provider_code not in ('none', 'custom'))"/>
            <div t-if="invoice.payment_state in ('paid', 'in_payment')" class="rounded text-bg-success fw-normal badge">
                <i class="fa fa-fw fa-check-circle"/> Paid
            </div>
            <div t-elif="pending_txs" class="rounded text-bg-info fw-normal badge">
                <i class="fa fa-fw fa-check-circle"/> Pending
            </div>
        </xpath>
        <xpath expr="//t[@t-call='portal.portal_record_sidebar']//div[hasclass('o_download_pdf')]" position="before">
            <a t-if="invoice._has_to_be_paid()"
                id="invoice_portal_pay_now_btn"
                href="#"
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#pay_with">
                <i class="fa fa-fw fa-arrow-circle-right"/> Pay Now
            </a>
        </xpath>
        <xpath expr="//div[@id='invoice_content']//div[hasclass('o_portal_html_view')]" position="before">
            <t t-set="tx" t-value="invoice.get_portal_last_transaction()"/>
            <div t-if="invoice.get_portal_last_transaction() and invoice.amount_total and not success and not error and (invoice.payment_state != 'not_paid' or tx.state in ('pending', 'authorized'))"
                 class="o_account_payment_tx_status"
                 t-att-data-invoice-id="invoice.id">
                <t t-call="payment.state_header"/>
            </div>
            <div t-if="invoice._has_to_be_paid()" id="portal_pay">
                <t t-call="account_payment.portal_invoice_payment"/>
            </div>
        </xpath>
    </template>

    <template id="portal_invoice_error" name="Invoice error display: payment errors"
            inherit_id="account.portal_invoice_error">
        <xpath expr="//t[@name='generic']" position="after">
            <t t-if="error == 'pay_invoice_invalid_doc'">
                There was an error processing your payment: invalid invoice.
            </t>
            <t t-elif="error == 'pay_invoice_invalid_token'">
                There was en error processing your payment: invalid credit card ID.
            </t>
            <t t-elif="error == 'pay_invoice_tx_fail'">
                There was an error processing your payment: transaction failed.<br />
                <t t-set="tx_sudo" t-value="invoice.get_portal_last_transaction()"/>
                <t t-if="tx_sudo and tx_sudo.state_message">
                    <t t-out="tx_sudo.state_message"/>
                </t>
            </t>
            <t t-elif="error == 'pay_invoice_tx_token'">
                There was an error processing your payment: issue with credit card ID validation.
            </t>
        </xpath>
    </template>

    <template id="portal_invoice_success" name="Invoice success display: payment success"
            inherit_id="account.portal_invoice_success">
        <xpath expr="//a[hasclass('close')]" position="after">
            <t t-if="success == 'pay_invoice'">
                <t t-set="tx_sudo" t-value="invoice.get_portal_last_transaction()"/>
                <span t-if="tx_sudo.provider_id.sudo().done_msg" t-out="tx_sudo.provider_id.sudo().done_msg"/>
                <div t-if="tx_sudo.provider_id.sudo().pending_msg and tx_sudo.provider_code == 'custom' and invoice.ref">
                    <b>Communication: </b><span t-out='invoice.ref'/>
                </div>
            </t>
            <t t-if="success == 'pay_invoice' and invoice.payment_state in ('paid', 'in_payment')">
                Done, your online payment has been successfully processed. Thank you for your order.
            </t>
        </xpath>
    </template>
</odoo>
