<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="optional_products_modal" name="Optional Products">
        <main class="modal-body">
            <t t-call="website_sale_product_configurator.configure_optional_products" />
        </main>
    </template>

    <template id="product_quantity_config">
        <div class="css_quantity input-group">
            <button t-attf-href="#" class="btn btn-link float_left js_add_cart_json border-end-0" aria-label="Remove one" title="Remove one">
                <i class="position-relative z-index-1 fa fa-minus"></i>
            </button>
            <input type="text"
                class="js_quantity form-control quantity border-start-0 border-end-0 text-center"
                data-min="1"
                name="add_qty"
                t-att-value="add_qty or 1"/>
            <button t-attf-href="#" class="btn btn-link float_left js_add_cart_json border-start-0" aria-label="Add one" title="Add one">
                <i class="position-relative z-index-1 fa fa-plus"></i>
            </button>
        </div>
    </template>

    <!-- backend -->
    <template id="configure" name="Configure">
        <div class="js_product main_product">

            <t t-set="combination" t-value="product_combination if product_combination else product._get_first_possible_combination()"/>
            <t t-set="combination_info" t-value="product._get_combination_info(combination, add_qty=add_qty or 1, pricelist=pricelist)"/>
            <t t-set="product_variant" t-value="product.env['product.product'].browse(combination_info['product_id'])"/>

            <input type="hidden" class="product_template_id" t-att-value="product.id"/>
            <input type="hidden" class="product_id" t-attf-name="product_id" t-att-value="product_variant.id"/>
            <input type="hidden" class="has_optional_products" t-attf-name="has_optional_products"
                   t-att-value="product_variant.optional_product_ids.filtered(lambda p: p._is_add_to_cart_possible(combination))"/>
            <div class="col-lg-12 text-center mt-5">
                <t t-if="product._is_add_to_cart_possible()">
                    <div class="col-lg-5 d-inline-block text-start">
                        <t t-if="combination" t-call="website_sale.variants">
                            <t t-set="parent_combination" t-value="None"/>
                        </t>
                        <h2>
                            <span t-attf-class="text-danger oe_default_price oe_striked_price {{'' if combination_info['has_discounted_price'] else 'd-none'}}"
                                t-out="combination_info['list_price']"
                                t-options='{
                                    "widget": "monetary",
                                    "display_currency": (pricelist or product.env.company).currency_id
                                }'/>
                            <span class="oe_price product_id mt-3" style="white-space: nowrap;"
                                t-att-data-product-id="product.id"
                                t-out="combination_info['price']"
                                t-options='{
                                    "widget": "monetary",
                                    "display_currency": (pricelist or product.env.company).currency_id
                                }'/>
                        </h2>
                        <t t-if="product.visible_qty_configurator">
                            <t t-call="website_sale_product_configurator.product_quantity_config" />
                        </t>
                        <p class="css_not_available_msg alert alert-warning">This combination does not exist.</p>
                    </div>
                    <div class="col-lg-1 d-inline-block"></div>
                    <div class="col-lg-5 d-inline-block align-top text-start">
                        <img t-if="product_variant" t-att-src="'/web/image/product.product/%s/image_1024' % product_variant.id" class="d-block product_detail_img" alt="Product Image"/>
                        <img t-else="" t-att-src="'/web/image/product.template/%s/image_1024' % product.id" class="d-block product_detail_img" alt="Product Image"/>
                    </div>
                </t>
                <t t-else="">
                    <div class="col-lg-5 d-inline-block text-start">
                        <p class="alert alert-warning">This product has no valid combination.</p>
                    </div>
                </t>
            </div>
        </div>
    </template>

    <!-- modal: full table, currenclty selected products at top -->
    <template id="configure_optional_products">
        <table class="o_wsale_modal_table table table-borderless h-100">
        <tbody>
            <tr class="js_product in_cart main_product h-100">

                <t t-set="combination_info" t-value="product.product_tmpl_id._get_combination_info(combination, product.id, add_qty or 1, pricelist)"/>
                <t t-set="product_variant" t-value="product.env['product.product'].browse(combination_info['product_id'])"/>

                <input type="hidden" class="product_template_id" t-att-value="product.product_tmpl_id.id"/>
                <input type="hidden" class="product_id" t-att-value="product_variant.id"/>
                <td class='td-img pb-4 d-none d-sm-table-cell'>
                    <img class="product_detail_img d-none d-sm-inline" t-if="product_variant" t-att-src="'/web/image/product.product/%s/image_64' % product_variant.id" alt="Product Image"/>
                    <img class="product_detail_img d-none d-sm-inline" t-else="" t-att-src="'/web/image/product.template/%s/image_64' % product.id" alt="Product Image"/>
                </td>
                <td class='td-product_name pb-4'>
                    <strong class="product-name product_display_name" t-out="combination_info['display_name']"/>
                    <div class="text-muted small">
                        <div t-field="product.description_sale"/>
                        <div class="js_attributes"/>
                        <div t-if="product_custom_attribute_values">
                            <t t-foreach="product_custom_attribute_values" t-as="custom_value">
                                <span t-esc="custom_value.get('attribute_value_name', None)"/>: <span t-esc="custom_value['custom_value']"/>
                                <input type="hidden" class="variant_custom_value"
                                       t-att-data-custom_product_template_attribute_value_id="custom_value['custom_product_template_attribute_value_id']"
                                       t-att-data-attribute_value_name="custom_value.get('attribute_value_name', None)"
                                       t-att-value="custom_value['custom_value']"/>
                            </t>
                        </div>
                    </div>
                    <div>
                        <t t-if="product.product_tmpl_id and not combination">
                            <t t-set="combination" t-value="product.product_tmpl_id._get_first_possible_combination()"/>
                        </t>
                        <t t-if="combination and not already_configured" t-call="website_sale.variants">
                            <t t-set="ul_class" t-valuef="flex-column" />
                            <t t-set="product" t-value="product.product_tmpl_id"/>
                        </t>
                        <t t-else="">
                            <ul class="d-none js_add_cart_variants mb-0" t-att-data-attribute_exclusions="{'exclusions: []'}"/>
                            <div class="d-none oe_unchanged_value_ids" t-att-data-unchanged_value_ids="variant_values" ></div>
                            <!-- Keep the information to use it later (when leaving the modal window) -->
                            <div class="d-none no-attribute-info" t-att-data-attribute-value='json.dumps(no_attribute)'></div>
                            <div class="d-none custom-attribute-info" t-att-data-attribute-value='json.dumps(custom_attribute)'></div>
                        </t>
                    </div>
                </td>
                <td class="text-end td-qty td-price h-100 pb-4">
                    <div class="d-flex flex-column align-items-end justify-content-between h-100">
                        <t t-call='website_sale_product_configurator.product_quantity_config' />
                                            <div t-attf-class="text-danger oe_default_price oe_striked_price {{'' if combination_info['has_discounted_price'] else 'd-none'}}"
                            t-out="combination_info['list_price']"
                            t-options='{
                                "widget": "monetary",
                                "display_currency": (pricelist or product.env.company).currency_id
                            }'
                        />
                        <span class="oe_price product_id h6 fw-bold mb-0" style="white-space: nowrap;"
                            t-att-data-product-id="product.id"
                            t-out="combination_info['price']"
                            t-options='{
                                "widget": "monetary",
                                "display_currency": (pricelist or product.env.company).currency_id
                            }'/>
                        <span class="js_raw_price d-none" t-out="product._get_contextual_price()"/>
                        <p class="css_not_available_msg alert alert-warning">Option not available</p>
                    </div>
                </td>
            </tr>
            <tr class="o_total_row">
                <td class="text-end border-top pb-4" colspan="3">
                    <strong>Total:</strong>
                    <span class="js_price_total fw-bold" style="white-space: nowrap;"
                        t-att-data-product-id="product.id"
                        t-out="combination_info['price'] * (add_qty or 1)"
                        t-options='{
                            "widget": "monetary",
                            "display_currency": (pricelist or product.env.company).currency_id
                        }'/>
                </td>
            </tr>
            <t t-if="product.optional_product_ids and mode != 'edit'">
                <tr class="o_select_options"><td class="rounded-top pb-0" colspan="3"><h4 class="pt-2">Add options</h4></td></tr>
                <t t-call="website_sale_product_configurator.optional_product_items">
                    <t t-set="parent_combination" t-value="combination"/>
                </t>
            </t>
        </tbody>
        </table>
    </template>

    <!-- modal: optional products -->
    <template id="optional_product_items">
        <t t-foreach="product.optional_product_ids" t-as="product">
            <t t-set="combination" t-value="product._get_first_possible_combination(parent_combination)"/>
            <t t-if="product._is_add_to_cart_possible(parent_combination)">

                <t t-set="combination_info" t-value="product._get_combination_info(combination, add_qty=add_qty or 1, pricelist=pricelist)"/>
                <t t-set="product_variant" t-value="product.env['product.product'].browse(combination_info['product_id'])"/>

                <tr class="js_product">
                    <td class="td-img pb-4 d-none d-sm-table-cell">
                        <input type="hidden" class="product_template_id" t-att-value="product.id"/>
                        <input type="hidden" class="product_id" t-attf-name="optional-product-#{product.id}" t-att-value="product_variant.id"/>
                        <img t-if="product_variant" t-att-src="'/web/image/product.product/%s/image_64' % product_variant.id"  class="variant_image" alt="Product Image"/>
                        <img t-else="" t-att-src="'/web/image/product.template/%s/image_64' % product.id"  class="variant_image" alt="Product Image"/>
                    </td>
                    <td class='td-product_name pb-4'>
                        <div class="mb-3">
                            <strong class="product-name product_display_name" t-out="combination_info['display_name']"/>
                            <div class="text-muted small" t-field="product.description_sale"/>
                        </div>
                        <t t-call="website_sale.variants">
                            <t t-set="ul_margin" t-value="true"/>
                            <t t-set="combination" t-value="product._get_first_possible_combination(parent_combination)"/>
                        </t>
                    </td>
                    <td class="td-price h-100 pb-4 text-end">
                        <div class="d-flex flex-column align-items-end justify-content-between gap-2 h-100">
                            <div class="o_qty_remove_div d-none flex-column flex-sm-row gap-2">
                                <span class="js_remove d-none order-2 order-sm-0">
                                    <a role="button" href="#" class="js_remove btn btn-light"><i class="fa fa-trash-o remove-optionnal-item"></i></a>
                                </span>
                                <t t-call='website_sale_product_configurator.product_quantity_config' />
                            </div>
                            <a role="button" href="#" class="js_add btn btn-outline-primary btn mb-4 text-nowrap">Add<span class="d-none d-md-inline"> to cart</span></a>
                            <p class="css_not_available_msg text-center alert alert-warning">Option not available</p>
                                <div t-attf-class="text-danger h6 fw-bold mb-0 mt-3 oe_default_price oe_optional oe_striked_price {{'' if combination_info['has_discounted_price'] else 'd-none'}}"
                                    t-out="combination_info['list_price']"
                                    t-options='{
                                        "widget": "monetary",
                                        "display_currency": (pricelist or product.env.company).currency_id
                                    }'/>
                                <div class="oe_price h6 fw-bold mb-0" style="white-space: nowrap;"
                                    t-out="combination_info['price']"
                                    t-options='{
                                        "widget": "monetary",
                                        "display_currency": (pricelist or product.env.company).currency_id
                                    }'/>
                                <span class="js_raw_price d-none" t-out="combination_info['price']" />
                        </div>
                    </td>
                </tr>
            </t>
        </t>
    </template>
</odoo>
